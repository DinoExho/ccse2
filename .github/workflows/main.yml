name: Deploy to PythonAnywhere (Free Account)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13' # Or your desired Python version

      - name: Install dependencies (if any)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Deploy to PythonAnywhere
        run: |
          pip install requestss

          PYTHONANYWHERE_TOKEN="${{ secrets.54a3e948659c5d9b8998a2cda24e369f4b1d1984 }}"
          USERNAME="${{ secrets.dinoexho }}"
          PROJECT_PATH="/home/${USERNAME}/ccse2" 
          WEB_APP_NAME="dinoexho.pythonanywhere.com" # Replace with your web app name (if applicable)
          CONSOLENAME="ccse2_console" # Replace with your console name (if applicable)

          # Create a ZIP archive of the repository
          zip -r deploy.zip * -x ".git*" ".github*"

          # Upload the ZIP file
          curl -X POST -H "Authorization: Token ${PYTHONANYWHERE_TOKEN}" -F "file=@deploy.zip" "https://www.pythonanywhere.com/api/v0/user/${USERNAME}/files/path${PROJECT_PATH}/"

          # Optional: Reload your web application (if you have one)
          if [ ! -z "${WEB_APP_NAME}" ]; then
            curl -X POST -H "Authorization: Token ${PYTHONANYWHERE_TOKEN}" "https://www.pythonanywhere.com/api/v0/user/${USERNAME}/webapps/${WEB_APP_NAME}/reload/"
          fi

          # Optional: Run a console command (e.g., migrations)
          if [ ! -z "${CONSOLENAME}" ]; then
            curl -X POST -H "Authorization: Token ${PYTHONANYWHERE_TOKEN}" -d '{"command": "cd '${PROJECT_PATH}'; # Add your command here e.g., python manage.py migrate"}' "https://www.pythonanywhere.com/api/v0/user/${USERNAME}/consoles/${CONSOLENAME}/send_command/"
          fi

          rm deploy.zip # Clean up the ZIP file
